1) How many visits are made per month on each product?

SELECT p.nome, MONTH (v.data_visita) AS mes, COUNT (ISNULL (s.status, 0))
FROM Produto p
LEFT JOIN Visita v
ON p.id_produto = v.id_produto
LEFT JOIN Status_visita s
ON s.status_visita = v.status_visita
WHERE s.status = 'realizada'
GROUP BY p.nome, mes
ORDER BY mes

2) What is the visit conversion rate (%) per product?

SELECT p.nome, Realizado * 100 / Total AS conversao(%)
FROM (
    SELECT
    COUNT (s.status) AS Realizado,
    COUNT (s.status) AS Total
    FROM Produto p
    WHERE status = 'realizada'
    LEFT JOIN Visita v
    ON p.id_produto = v.id_produto
    LEFT JOIN Status_visita s
    ON s.status_visita = v.status_visita )
GROUP BY p.nome
ORDER BY conversao(%) DESC

3) To assign media to a visit, we consider the first contact made by that customer in the last 120 days prior to the date of the visit. 
Which media channels generate the most visits?

WITH primeira_midia AS (
    SELECT
        contato.id_cliente,
        visita.id_visita,
        contato.data_contato,
        visita.data_visita,
        midia.nome AS nome_midia,
        ROW_NUMBER() OVER (PARTITION BY contato.id_cliente, visita.id_visita ORDER BY contato.data_contato) AS num_linha
    FROM
        contato
    LEFT JOIN
        midia
                ON contato.id_midia = midia.id_midia
    LEFT JOIN
        visita
                ON contato.id_cliente = visita.id_cliente
    WHERE
        contato.data_contato >= visita.data_visita - 120)
SELECT
   	nome_midia,
   	COUNT(*) AS qty_leads
FROM
   	primeira_midia
WHERE
   	num_linha = 1
ORDER BY
qty_leads DESC
